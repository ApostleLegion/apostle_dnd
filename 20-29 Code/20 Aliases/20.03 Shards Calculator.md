# Shards Calculator
## "Business" Logic
**Command.** `!shards -difficulty <easy|medium|hard|deadly> -pavg #`
- *Difficulty.* This is the difficulty of the encounter via DMG difficulty calculations
- *pavg.* The average level of the party

This calculator uses the following logic based on encounter difficulty:
- Easy encounters offer a 75% chance to earn 1 shard
- Medium encounters offer a 75% chance to earn 1 shard and a 50% chance to earn a second shard
- Hard encounters offer a 75% chance to earn 1 shard, 50% chance to earn a second shard, and a 25% chance to earn a third shard; shards have a 10% chance to increase in rarity by 1 degree
- Deadly encounters offer a 100% chance to earn 1 shard, 75% chance to earn a second shard, 50% chance to earn a third shard, and a 25% chance to earn a fourth shard; shards have a 25% to increase in rarity by 1 degree

The following logic is applied based on average party level:
- Tier 1 play is given **glimmering** shards with a chance at **glowing**
- Tier 2 play is given **glowing** shards with a chance at **radiant**
- Tier 3 play is given **radiant** shards with a chance at **brilliant**
- Tier 4 play is given **brilliant** shards with a chance at **prismatic**

Additional Rules:
- Each prismatic shard makes 2 brilliant, 4 radiant, 8 glowing, and 16 glimmering shards available
- Each brilliant shard makes 2 radiant, 4 glowing, and 8 glimmering shards available
- Each radiant shard makes 2 glowing and 4 glimmering shards available
- Each glowing shard makes 2 glimmering shards available

*Note.* These "lesser shards" are not used in the calculation. i.e. a radiant shard generated by the presence of a prismatic shard does not also offer 2 glowing and 4 glimmering shards.

## Code (Draconic)
```python
!alias shards embed <drac2>
H=True if str("&1&")=='help' else False
A=argparse(&ARGS&)
diff=A.last("difficulty")
diff=diff if diff else "easy"
pavg=A.last("pavg")
pavg=int(pavg if pavg else 1)
diff_table = [{"diff":"easy","num":1,"chance":75,"up":101},
              {"diff":"medium","num":2,"chance":50,"up":101},
              {"diff":"hard","num":3,"chance":25,"up":90},
              {"diff":"deadly","num":4,"chance":0,"up":75}]
const_table = [{"min":1,"max":4,"shard":"glimmering","up":"glowing"},
                {"min":5,"max":10,"shard":"glowing","up":"radiant"},
                {"min":11,"max":16,"shard":"radiant","up":"brilliant"},
                {"min":17,"max":20,"shard":"brilliant","up":"prismatic"}]
shards=[]
rolls=[]
for drec in diff_table:
  if drec['diff'] == diff:
    ms = drec['num']
    sch = drec['chance']

    while ms > 0:
      shrl=vroll('1d100')
      rolls.append({"roll":shrl.full,"target":sch,"shard":"yes" if shrl.total >= sch else "no"})
      if shrl.total >= sch:
        shards.append(drec['up'])
      sch+=25
      ms-=1
    break

final_shards=[]
for item in const_table:
  if item['min'] <= pavg <= item['max']:
    for shard in shards:
      up_roll=vroll('1d100')
      rolls.append({"uproll":up_roll.full,"target":shard,"upgrade":"yes" if up_roll.total >= shard else"no"})
      if up_roll.total >= shard:
        final_shards.append(item['up'])
      else:
        final_shards.append(item['shard'])

shard_delivery={'prismatic':0,'brilliant':0,'radiant':0,'glowing':0,'glimmering':0}
lesser_shards={'brilliant':0,'radiant':0,'glowing':0,'glimmering':0}
rolled_shards = set(final_shards)
if 'prismatic' in rolled_shards:
    lesser_shards['brilliant'] += 2
    lesser_shards['radiant'] += 4
    lesser_shards['glowing'] += 6
    lesser_shards['glimmering'] += 8
elif 'brilliant' in rolled_shards:
    lesser_shards['radiant'] += 2
    lesser_shards['glowing'] += 4
    lesser_shards['glimmering'] += 6
elif 'radiant' in rolled_shards:
    lesser_shards['glowing'] += 2
    lesser_shards['glimmering'] += 4
elif 'glowing' in rolled_shards:
    lesser_shards['glimmering'] += 2

for shard in set(final_shards):
    shard_delivery[shard] += final_shards.count(shard)

shard_delivery['brilliant'] += lesser_shards['brilliant']
shard_delivery['radiant'] += lesser_shards['radiant']
shard_delivery['glowing'] += lesser_shards['glowing']
shard_delivery['glimmering'] += lesser_shards['glimmering']

for key in list(shard_delivery):
    if shard_delivery[key] == 0:
        shard_delivery.pop(key)

shard_tally=str(shard_delivery).replace('\'','').replace('{','').replace('}','').replace(' ','').replace(',','\n- ').replace(':',': ')
shard_tally=f'- {shard_tally}' if len(shard_tally) > 0 else "- No Shards Rolled"
rolls=str(rolls).replace("\'","\\'")
rolls=rolls.replace('},', '\n').replace('[','').replace('{','').replace('}','').replace(']','')


Z="`!shards -difficulty [easy,medium,hard,deadly] -pavg #`\n\n`-difficulty` is the encounter difficulty from the selected list:\n- `easy`\n- `medium`\n- `hard`\n- `deadly`\n\n`-pavg` is the average party level."
</drac2>
-title "Shard Rewards Calculator"
-desc '{{f"*{diff.title()} Level {pavg} Encounter*\n{shard_tally}\n\n*Rolls & Targets*\n{rolls}" if not H else Z }}'
-footer "'!shards help' by glynyon#5020"
-thumb https://cdn.discordapp.com/attachments/1041900983615242260/1112597907602948186/inv_enchant_shardprismaticlarge.jpg
-color #705fa6
```

## Code (Python)
```py
from random import randint

difficulty_table = [{"difficulty":"easy","number_of_shard_chances":1,"chance":75,"up":101},
              {"difficulty":"medium","number_of_shard_chances":2,"chance":50,"up":101},
              {"difficulty":"hard","number_of_shard_chances":3,"chance":25,"up":90},
              {"difficulty":"deadly","number_of_shard_chances":4,"chance":0,"up":75}]
shard_table = [{"min":1,"max":4,"shard":"glimmering","up":"glowing"},
                {"min":5,"max":10,"shard":"glowing","up":"radiant"},
                {"min":11,"max":16,"shard":"radiant","up":"brilliant"},
                {"min":17,"max":20,"shard":"brilliant","up":"prismatic"}]

def shards(difficulty='easy', party_average=1, help=False):
    obtained_shards=[]
    rolls=[]
    for difficulty_record in difficulty_table:
        if difficulty_record['difficulty'] == difficulty:
            number_of_shard_chances = difficulty_record['number_of_shard_chances']
            shard_chance = difficulty_record['chance']

            while number_of_shard_chances > 0:
                shard_roll = randint(1,100)
                rolls.append({"roll":f'1d100 = {shard_roll}',"target":shard_chance,"upgrade":"yes" if shard_roll >= shard_chance else "no"})
                if shard_roll >= shard_chance:
                    obtained_shards.append(difficulty_record['up'])
                shard_chance += 25
                number_of_shard_chances -= 1

    final_shards=[]
    for shard_type in shard_table:
        if shard_type['min'] <= party_average <= shard_type['max']:
            for shard in obtained_shards:
                up_roll=randint(1,100)
                rolls.append({"uproll":f'1d100 = {up_roll}',"target":shard,"upgrade":"yes" if up_roll >= shard else "no"})
                if up_roll >= shard:
                    final_shards.append(shard_type['up'])
                else:
                    final_shards.append(shard_type['shard'])

    # add "freebie" shards
    shard_delivery={'prismatic':0,'brilliant':0,'radiant':0,'glowing':0,'glimmering':0}
    lesser_shards={'brilliant':0,'radiant':0,'glowing':0,'glimmering':0}

    rolled_shards = set(final_shards)
    if 'prismatic' in rolled_shards:
        lesser_shards['brilliant'] += 2
        lesser_shards['radiant'] += 4
        lesser_shards['glowing'] += 6
        lesser_shards['glimmering'] += 8
    elif 'brilliant' in rolled_shards:
        lesser_shards['radiant'] += 2
        lesser_shards['glowing'] += 4
        lesser_shards['glimmering'] += 6
    elif 'radiant' in rolled_shards:
        lesser_shards['glowing'] += 2
        lesser_shards['glimmering'] += 4
    elif 'glowing' in rolled_shards:
        lesser_shards['glimmering'] += 2

    for shard in set(final_shards):
        shard_delivery[shard] += final_shards.count(shard)

    shard_delivery['brilliant'] += lesser_shards['brilliant']
    shard_delivery['radiant'] += lesser_shards['radiant']
    shard_delivery['glowing'] += lesser_shards['glowing']
    shard_delivery['glimmering'] += lesser_shards['glimmering']

    for key in list(shard_delivery):
        if shard_delivery[key] == 0:
            shard_delivery.pop(key)
    
    if len(shard_delivery) < 1:
        return_shard_count = 'No Shards Rolled'
    else:
        return_shard_count = shard_delivery

    if not help:
        print("\nShard Rewards Calculator\n")
        print("============================")
        print(f"{difficulty.title()} Level {party_average} Encounter")
        print(f"Shards\n-------------\n{shard_delivery}\n-------------\n")
        print(f"Rolls & Targets\n-------------\n{rolls}")
    else:
        print("This would be the help menu")

shards(difficulty='deadly', party_average=20)
```
