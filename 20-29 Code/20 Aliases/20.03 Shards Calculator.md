# Shards Calculator
## "Business" Logic
**Command.** `!shards -difficulty <easy|medium|hard|deadly> -pavg #`
- *Difficulty.* This is the difficulty of the encounter via DMG difficulty calculations
- *pavg.* The average level of the party

This calculator uses the following logic based on encounter difficulty:
- Easy encounters offer a 75% chance to earn 1 shard
- Medium encounters offer a 75% chance to earn 1 shard and a 50% chance to earn a second shard
- Hard encounters offer a 75% chance to earn 1 shard, 50% chance to earn a second shard, and a 25% chance to earn a third shard; shards have a 10% chance to increase in rarity by 1 degree
- Deadly encounters offer a 100% chance to earn 1 shard, 75% chance to earn a second shard, 50% chance to earn a third shard, and a 25% chance to earn a fourth shard; shards have a 25% to increase in rarity by 1 degree

The following logic is applied based on average party level:
- Tier 1 play is given **glimmering** shards with a chance at **glowing**
- Tier 2 play is given **glowing** shards with a chance at **radiant**
- Tier 3 play is given **radiant** shards with a chance at **brilliant**
- Tier 4 play is given **brilliant** shards with a chance at **prismatic**

Additional Rules:
- Each prismatic shard makes 2 brilliant, 4 radiant, 8 glowing, and 16 glimmering shards available
- Each brilliant shard makes 2 radiant, 4 glowing, and 8 glimmering shards available
- Each radiant shard makes 2 glowing and 4 glimmering shards available
- Each glowing shard makes 2 glimmering shards available

*Note.* These "lesser shards" are not used in the calculation. i.e. a radiant shard generated by the presence of a prismatic shard does not also offer 2 glowing and 4 glimmering shards.

## Code
```python
!alias shards embed <drac2>
H=True if str("&1&")=='help' else False
A=argparse(&ARGS&)
diff=A.last("difficulty")
diff=diff if diff else "easy"
pavg=A.last("pavg")
pavg=int(pavg if pavg else 1)
diff_table = [{"diff":"easy","num":1,"chance":75,"up":101},
              {"diff":"medium","num":2,"chance":50,"up":101},
              {"diff":"hard","num":3,"chance":25,"up":90},
              {"diff":"deadly","num":4,"chance":0,"up":75}]
const_table = [{"min":1,"max":4,"shard":"glimmering","up":"glowing"},
                {"min":5,"max":10,"shard":"glowing","up":"radiant"},
                {"min":11,"max":16,"shard":"radiant","up":"brilliant"},
                {"min":17,"max":20,"shard":"brilliant","up":"prismatic"}]
shards=[]
rolls=[]
for drec in diff_table:
  if drec['diff'] == diff:
    ms = drec['num']
    sch = drec['chance']

    while ms > 0:
      shrl=vroll('1d100')
      rolls.append({"roll":shrl.full,"target":sch,"shard":"yes" if shrl.total >= sch else "no"})
      if shrl.total >= sch:
        shards.append(drec['up'])
      sch+=25
      ms-=1
    break

final_shards=[]
for item in const_table:
  if item['min'] <= pavg <= item['max']:
    for shard in shards:
      up_roll=vroll('1d100')
      rolls.append({"uproll":up_roll.full,"target":shard,"upgrade":"yes" if up_roll.total >= shard else"no"})
      if up_roll.total >= shard:
        final_shards.append(item['up'])
      else:
        final_shards.append(item['shard'])

test={}
lesser_shards={'prismatic':0,'brilliant':0,'radiant':0,'glowing':0,'glimmering':0}
for i in set(final_shards):
  test[i]=final_shards.count(i)
  lesser_shards[i] += final_shards.count(i)
  if i != 'glimmering':
    if i == 'prismatic':
      lesser_shards['brilliant'] += 2*test[i]
      lesser_shards['radiant'] += 4*test[i]
      lesser_shards['glowing'] += 8*test[i]
      lesser_shards['glimmering'] += 16*test[i]
    elif i == 'brilliant':
      lesser_shards['radiant'] += 2*test[i]
      lesser_shards['glowing'] += 4*test[i]
      lesser_shards['glimmering'] += 8*test[i]
    elif i == 'radiant':
      lesser_shards['glowing'] += 2*test[i]
      lesser_shards['glimmering'] += 4*test[i]
    elif i == 'glowing':
      lesser_shards['glimmering'] += 2*test[i]
if len(test) == 0:
  test = "No Shards Rolled"

for key in list(lesser_shards):
  if lesser_shards[key] == 0:
    lesser_shards.pop(key)

test=str(test).replace("\'", "\\'")
shard_tally=str(lesser_shards).replace('\'','').replace('{','').replace('}','').replace(' ','').replace(',','\n- ').replace(':',': ')
shard_tally=f'- {shard_tally}' if len(shard_tally) > 0 else "- No Shards Rolled"
rolls=str(rolls).replace("\'","\\'")
rolls=rolls.replace('},', '\n').replace('[','').replace('{','').replace('}','').replace(']','')


Z="`!shards -difficulty [easy,medium,hard,deadly] -pavg #`\n\n`-difficulty` is the encounter difficulty from the selected list:\n- `easy`\n- `medium`\n- `hard`\n- `deadly`\n\n`-pavg` is the average party level."
</drac2>
-title "Shard Rewards Calculator"
-desc '{{f"*{diff.title()} Level {pavg} Encounter*\n{shard_tally}\n\n*Rolls & Targets*\n{rolls}" if not H else Z }}'
-footer "'!shards help' by glynyon#5020"
-thumb https://cdn.discordapp.com/attachments/1041900983615242260/1112597907602948186/inv_enchant_shardprismaticlarge.jpg
-color #705fa6
```
